"use strict";(self._cf=self._cf||[]).push([[72178],{272178:(e,i,t)=>{t.d(i,{ZP:()=>Z,Nn:()=>U});var o=t(615919),s=t(199009),r=t(599635),n=t(2422),a=t(324855),h=t(126614),d=t(466011),c=t(531461),m=t(291542);class l{constructor(e){(0,s.Z)(this,"config",void 0),this.config=e}loadEmoji(){return(0,m.UX)(this.config).then((e=>(0,m.ud)(e)))}}var u=t(101244),p=t(872342),g=t(542434),j=t(314942);class f{constructor(e,i){(0,s.Z)(this,"tokenManager",void 0),(0,s.Z)(this,"mediaImageQueue",[]),(0,s.Z)(this,"activeProcessing",0),(0,s.Z)(this,"concurrentDownloadLimit",void 0),(0,s.Z)(this,"pendingRequests",new Map),this.concurrentDownloadLimit=i&&i.concurrentDownloadLimit||16,this.tokenManager=e}loadMediaImage(e){const i=this.pendingRequests.get(e);if(void 0!==i)return i;const t=new Promise(((i,t)=>{this.mediaImageQueue.push({url:e,resolve:i,reject:t}),this.processFromQueue()})).then((i=>(this.pendingRequests.delete(e),i))).catch((i=>{throw this.pendingRequests.delete(e),i}));return this.pendingRequests.set(e,t),t}getQueueSize(){return this.mediaImageQueue.length}getActiveDownloads(){return this.activeProcessing}processFromQueue(){for(;this.activeProcessing<this.concurrentDownloadLimit&&this.mediaImageQueue.length>0;){this.activeProcessing++;const e=this.mediaImageQueue.shift(),{url:i,resolve:t,reject:o}=e;this.tokenManager.getToken("read",!1).then((e=>{this.requestMediaEmoji(i,e,!0).then((e=>{t(e),this.completedItem()})).catch((e=>{o(e),this.completedItem()}))})).catch((e=>{o(e),this.completedItem()}))}}completedItem(){this.activeProcessing--,this.processFromQueue()}delay(e){return new Promise((i=>setTimeout(i,e)))}requestMediaEmoji(e,i,t,o=2){return(0,j.To)().then((s=>{const r={headers:{Authorization:`Bearer ${i.jwt}`,"X-Client-Id":i.clientId,Accept:s}};return fetch(e,r).then((s=>{if(404===s.status&&o>0)return this.delay(600/o).then((()=>this.requestMediaEmoji(e,i,!1,o-1)));if(403===s.status&&t)return this.tokenManager.getToken("read",!0).then((i=>this.requestMediaEmoji(e,i,!1)));if(s.ok)return s.blob().then((e=>this.readBlob(e)));throw new Error(`Unable to load media image. Status=${s.status} ${s.statusText}`)}))}))}readBlob(e){return new Promise(((i,t)=>{const o=new FileReader;o.addEventListener("load",(()=>i(o.result))),o.addEventListener("error",(()=>t(o.error))),o.readAsDataURL(e)}))}}var v=t(334806);const y=(e,i)=>i?e.altRepresentation:e.representation;class R{constructor(e){(0,s.Z)(this,"cachedImageUrls",new Set),(0,s.Z)(this,"mediaImageLoader",void 0),(0,a.ZP)("BrowserCacheStrategy"),this.mediaImageLoader=e}loadEmoji(e,i){const t=y(e,i);if(!(0,h.$m)(t))return e;const{mediaPath:o}=t;return this.cachedImageUrls.has(o)?e:this.mediaImageLoader.loadMediaImage(o).then((()=>(this.cachedImageUrls.add(o),e))).catch((()=>{}))}optimisticRendering(){return!0}static supported(e,i){return(()=>{const e=!!document.documentMode,i=!e&&!!window.StyleMedia;return e||i})()?Promise.resolve(!1):i.loadMediaImage(e).then((()=>new Promise((i=>{const t=new Image;t.addEventListener("load",(()=>{i(!0)})),t.addEventListener("error",(()=>{i(!1)})),t.src=e})))).catch((()=>!1))}}class E{constructor(e){(0,s.Z)(this,"dataURLCache",void 0),(0,s.Z)(this,"mediaImageLoader",void 0),(0,a.ZP)("MemoryCacheStrategy"),this.mediaImageLoader=e,this.dataURLCache=new v.LRUMap(1e3)}loadEmoji(e,i){const t=y(e,i);if(!(0,h.$m)(t))return e;const{mediaPath:o}=t,s=this.dataURLCache.get(o);return s?(0,h.Ez)(e,s,i):this.mediaImageLoader.loadMediaImage(o).then((t=>{const s=(0,h.Ez)(e,t,i);return t.length<=1e4?this.dataURLCache.set(o,t):(0,a.ZP)("No caching as image is too large",t.length,t.slice(0,15),e.shortName),s})).catch((()=>{}))}optimisticRendering(){return!1}}class w{constructor(e){(0,s.Z)(this,"cache",void 0),(0,s.Z)(this,"waitingInitUrls",[]),(0,s.Z)(this,"cacheLoading",void 0),(0,s.Z)(this,"mediaImageLoader",void 0),(0,a.ZP)("MediaEmojiCache"),this.mediaImageLoader=new f(e)}loadEmoji(e,i){const t=y(e,i);if(!(0,h.$m)(t))return e;const{mediaPath:o}=t,s=this.getCache(o);return(0,h.tI)(s)?s.then((t=>t.loadEmoji(e,i))).catch((()=>{})):s.loadEmoji(e,i)}optimisticRendering(e){const i=this.getCache(e);return(0,h.tI)(i)?i.then((e=>e.optimisticRendering())).catch((()=>!1)):i.optimisticRendering()}getCache(e){return this.cache?this.cache:(this.waitingInitUrls.push(e),this.cacheLoading||(this.cacheLoading=this.initCache().then((e=>(this.cache=e,this.cacheLoading=void 0,e))).catch((e=>{throw this.cacheLoading=void 0,e}))),this.cacheLoading)}initCache(){const e=this.waitingInitUrls.pop();return e?R.supported(e,this.mediaImageLoader).then((e=>(this.waitingInitUrls=[],this.cacheLoading=void 0,e?new R(this.mediaImageLoader):new E(this.mediaImageLoader)))).catch((()=>this.initCache())):Promise.reject("Unable to initialise cache based on provided url(s)")}}class I{constructor(e){(0,s.Z)(this,"siteServiceConfig",void 0),(0,s.Z)(this,"tokens",void 0),this.siteServiceConfig=e,this.tokens=new Map}isValidToken(e){return Date.now()/1e3<e.expiresAt-30}fetchNewToken(e){return r.P6.requestService(this.siteServiceConfig,{path:`token/${e}`})}addToken(e,i){this.tokens.set(e,{mediaApiToken:i})}getToken(e,i){let t=this.tokens.get(e);t||(t={},this.tokens.set(e,t));const{mediaApiToken:o,activeTokenRefresh:s}=t;return o&&this.isValidToken(o)&&!i?Promise.resolve(o):s||(t.activeTokenRefresh=this.fetchNewToken(e).then((e=>(t.mediaApiToken=e,t.activeTokenRefresh=void 0,e))),t.activeTokenRefresh)}}const P=["altRepresentations"];class L{constructor(e,i){(0,s.Z)(this,"siteServiceConfig",void 0),(0,s.Z)(this,"mediaApiToken",void 0),(0,s.Z)(this,"mediaEmojiCache",void 0),(0,s.Z)(this,"tokenManager",void 0),(0,s.Z)(this,"postToEmojiService",((e,i)=>{const{shortName:t,name:s}=e,{width:n,height:a}=e,d={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shortName:t,name:s,width:n,height:a,fileId:i})};return r.P6.requestService(this.siteServiceConfig,{requestInit:d}).then((e=>{const{emojis:i}=e;if(i.length){const e=i[0],{altRepresentations:t}=e,s=(0,p.Z)(e,P),r=(0,o.Z)((0,o.Z)({},s),{},{representation:(0,h.oX)(s.representation)}),n=(0,m.E2)(t||{}),a=n?(0,h.oX)(n):void 0;return(0,h._p)(r,a)}throw new Error("No emoji returns from upload. Upload failed.")}))})),this.siteServiceConfig=e,this.mediaApiToken=i,this.tokenManager=new I(e),this.tokenManager.addToken("read",i),this.mediaEmojiCache=new w(this.tokenManager)}async generateTokenisedMediaURLS(e,i){if(!(0,h.$m)(e))return{representation:e,altRepresentation:i};try{const t=await this.tokenManager.getToken("read");return Object.entries({representation:e,altRepresentation:i}).reduce(((e,[i,s])=>{if(s&&(0,h.$m)(s)){const r=new URL(s.mediaPath),n=r.searchParams;n.get("token")!==t.jwt&&n.set("token",t.jwt),n.get("client")!==t.clientId&&n.set("client",t.clientId),e[i]=(0,o.Z)((0,o.Z)({},s),{},{mediaPath:r.toString()})}return e}),{representation:e,altRepresentation:i})}catch(t){return{representation:e,altRepresentation:i}}}loadMediaEmoji(e,i){if(!(0,h.tE)(e))throw new Error("Only supported for media emoji");return this.mediaEmojiCache.loadEmoji(e,i)}optimisticRendering(e,i){const t=i?e.altRepresentation:e.representation;if(!(0,h.$m)(t))throw new Error("Only supported for media emoji");const{mediaPath:o}=t;return this.mediaEmojiCache.optimisticRendering(o)}uploadEmoji(e,i=!1,t){const o=Date.now();return this.tokenManager.getToken("upload",i).then((i=>{const s=Date.now()-o;return(0,a.ZP)("upload token load time",s),new Promise(((r,n)=>{const{url:h,clientId:d,collectionName:c}=i,m=(0,g.y0)({authProvider:()=>Promise.resolve({clientId:d,token:i.jwt,baseUrl:h})}).file.upload({content:e.dataURL,name:e.filename,collection:c}).subscribe({next:i=>{if("uploading"===i.status&&t)t({percent:.95*i.progress});else if("processing"===i.status){m.unsubscribe();const t=Date.now()-o,h=t-s;(0,a.ZP)("total upload / media upload times",t,h),this.postToEmojiService(e,i.id).then((e=>{r(e)})).catch((e=>{n(e.reason||e)}))}},error(e){n(e)}})}))}))}hasUploadToken(){return this.tokenManager.getToken("upload").then((e=>void 0!==e),(()=>!1))}prepareForUpload(){this.tokenManager.getToken("upload")}findEmoji(e){if(!e.id)return Promise.reject(!1);const i=`../${encodeURIComponent(e.id)}`;return(0,m.UX)(this.siteServiceConfig,{path:i}).then((e=>(0,m.ud)(e).emojis[0])).catch((i=>{(0,a.ZP)("failed to load emoji",e,i)}))}deleteEmoji(e){if(!(0,h.tE)(e)&&!(0,h.k0)(e))return Promise.reject(!1);if(!e.id)return Promise.reject(!1);const i=`${encodeURIComponent(e.id)}`;return r.P6.requestService(this.siteServiceConfig,{path:i,requestInit:{method:"DELETE"}}).then((()=>!0)).catch((()=>!1))}}var A=t(245901);const U=e=>{const i=e;return!!i.isUploadSupported&&!!i.uploadCustomEmoji&&!!i.prepareForUpload};class k extends r.a3{constructor(e){if(super(),(0,s.Z)(this,"recordConfig",void 0),(0,s.Z)(this,"emojiRepository",void 0),(0,s.Z)(this,"lastQuery",void 0),(0,s.Z)(this,"activeLoaders",0),(0,s.Z)(this,"initialLoaders",0),(0,s.Z)(this,"retries",new Map),(0,s.Z)(this,"siteEmojiResource",void 0),(0,s.Z)(this,"selectedTone",void 0),(0,s.Z)(this,"currentUser",void 0),(0,s.Z)(this,"isInitialised",!1),(0,s.Z)(this,"fetchOnDemand",!1),(0,s.Z)(this,"emojiResponses",void 0),(0,s.Z)(this,"emojiProviderConfig",void 0),(0,s.Z)(this,"getOptimisticImageURL",(e=>{if(this.emojiProviderConfig.optimisticImageApi)return this.emojiProviderConfig.optimisticImageApi.getUrl(e)})),(0,s.Z)(this,"isRepositoryAvailable",(e=>!!e)),(0,s.Z)(this,"isLoaded",(()=>0!==this.initialLoaders&&0===this.activeLoaders)),this.emojiProviderConfig=e,this.recordConfig=e.recordConfig,this.currentUser=e.currentUser,(0,d.Z)("localStorage")&&(this.selectedTone=this.loadStoredTone()),0===e.providers.length)throw new Error("No providers specified");this.fetchOnDemand=!!e.options&&!!e.options.onlyFetchOnDemand,this.initialLoaders=this.emojiProviderConfig.providers.length,this.activeLoaders=this.emojiProviderConfig.providers.length,this.emojiResponses=[]}async getEmojiProvider(e={fetchAtStart:!this.fetchOnDemand}){if(e.fetchAtStart)try{await this.fetchEmojiProvider()}catch(i){return(0,a.ZP)(i),Promise.resolve(this)}return Promise.resolve(this)}async fetchIndividualProvider(e,i){const t=this.getProviderType(e);try{(0,A.PI)(t).start({samplingRate:n.uC}),(0,A.PI)(t).addMetadata({type:t});const o=new l(e),s=await o.loadEmoji();(0,A.PI)(t).success(),this.emojiResponses[i]=s,this.initEmojiRepository(this.emojiResponses),await this.initSiteEmojiResource(s,e),this.activeLoaders--,this.performRetries(),this.refreshLastFilter()}catch(o){throw this.activeLoaders--,this.notifyError(o),(0,A.PI)(t).failure({metadata:{reason:o,source:"EmojiProvider",providerUrl:e.url}}),(0,a.ZP)(`failed to fetch emoji provider for ${e.url}`,o),new Error(`failed to fetch emoji from ${e.url}`)}}async fetchEmojiProvider(e=!1){return(e||!this.isRepositoryAvailable(this.emojiRepository)&&!this.isInitialised)&&(this.isInitialised=!0,this.emojiResponses=[],await Promise.all(this.emojiProviderConfig.providers.map(((e,i)=>this.fetchIndividualProvider(e,i))))),Promise.resolve(this.emojiRepository)}onlyFetchOnDemand(){return this.fetchOnDemand}async fetchByEmojiId(e,i){if(this.isLoaded()&&this.isRepositoryAvailable(this.emojiRepository)){const i=await this.findByEmojiId(e);if(i)return await this.getMediaEmojiDescriptionURLWithInlineToken(i)}if(this.emojiProviderConfig.singleEmojiApi&&i){const i={url:this.emojiProviderConfig.singleEmojiApi.getUrl(e),securityProvider:this.emojiProviderConfig.singleEmojiApi.securityProvider},t=new l(i);try{const e=await t.loadEmoji();if(!e.emojis[0])return;return this.isRepositoryAvailable(this.siteEmojiResource)||await this.initSiteEmojiResource(e,i),this.getMediaEmojiDescriptionURLWithInlineToken(e.emojis[0])}catch(o){const i=await this.findByEmojiId(e);if(!i)return;return this.getMediaEmojiDescriptionURLWithInlineToken(i)}}const t=await this.findByEmojiId(e);if(t)return this.getMediaEmojiDescriptionURLWithInlineToken(t)}getProviderType(e){return e.url.includes("/site")?c.yI.SITE:e.url.includes("/standard")?c.yI.STANDARD:e.url.includes("/atlassian")?c.yI.ATLASSIAN:c.yI.UNKNOWN}initEmojiRepository(e){let i=[];e.forEach((e=>{i=i.concat(e.emojis)})),this.emojiRepository=new u.Z(i)}initSiteEmojiResource(e,i){if(!this.isRepositoryAvailable(this.siteEmojiResource)&&e.mediaApiToken){this.siteEmojiResource=new L(i,e.mediaApiToken);const{emojis:t}=e;if(t.length){const e=this.siteEmojiResource.optimisticRendering(t[0]);if((0,h.tI)(e))return e.then((()=>{(0,a.ZP)("Primed siteEmojiResource")})).catch((()=>{(0,a.ZP)("Failed to prime siteEmojiResource")}));(0,a.ZP)("Already primed siteEmojiResource")}else(0,a.ZP)("No emoji to prime siteEmojiResource with")}return Promise.resolve()}performRetries(){const e=this.retries;this.retries=new Map,e.forEach(((e,i)=>{const t=i();(0,h.tI)(t)?t.then((i=>{e.resolve(i)})).catch((i=>{e.reject(i)})):e.resolve(t)}))}loadStoredTone(){if("undefined"==typeof window)return;const e=window.localStorage.getItem(n.Qz);if(e){const i=parseInt(e,10);return isNaN(i)?void 0:i}}refreshLastFilter(){if(void 0!==this.lastQuery){const{query:e,options:i}=this.lastQuery;this.filter(e,i)}}retryIfLoading(e,i){return this.isLoaded()?Promise.resolve(i):new Promise(((i,t)=>{this.retries.set(e,{resolve:i,reject:t})}))}notifyResult(e){this.lastQuery&&e.query===this.lastQuery.query&&super.notifyResult(e)}async getMediaEmojiDescriptionURLWithInlineToken(e){if(this.isRepositoryAvailable(this.siteEmojiResource)){const{representation:i,altRepresentation:t}=await this.siteEmojiResource.generateTokenisedMediaURLS(e.representation,e.altRepresentation);return(0,o.Z)((0,o.Z)({},e),{},{representation:i,altRepresentation:t})}return e}loadMediaEmoji(e,i){return this.isRepositoryAvailable(this.siteEmojiResource)&&(0,h.tE)(e)?this.siteEmojiResource.loadMediaEmoji(e,i):e}optimisticMediaRendering(e,i){if(!(0,h.tE)(e))return!0;if(!this.isRepositoryAvailable(this.siteEmojiResource))return!1;const t=this.siteEmojiResource.optimisticRendering(e,i);return!(0,h.tI)(t)&&t}filter(e,i){if(A.vb["emoji-searched"].start(),A.vb["emoji-searched"].addMetadata({queryLength:(null==e?void 0:e.length)||0}),this.lastQuery={query:e,options:i},this.isRepositoryAvailable(this.emojiRepository)){const t=this.emojiRepository.search(e,i);this.notifyResult(t),A.vb["emoji-searched"].success({metadata:{emojisLength:t.emojis.length,source:(null==i?void 0:i.source)||"typeahead"}})}else this.notifyNotReady()}findByShortName(e){return this.isLoaded()&&this.isRepositoryAvailable(this.emojiRepository)?this.emojiRepository.findByShortName(e):this.retryIfLoading((()=>this.findByShortName(e)),void 0)}findByEmojiId(e){const{id:i,shortName:t}=e;if(this.isRepositoryAvailable(this.emojiRepository)){if(!i)return this.findByShortName(t);{const o=this.emojiRepository.findById(i);if(o)return o;if(this.isLoaded())return this.isRepositoryAvailable(this.siteEmojiResource)?this.siteEmojiResource.findEmoji(e).then((e=>e?(this.addUnknownEmoji(e),e):this.findByShortName(t))):this.findByShortName(t)}}return this.retryIfLoading((()=>this.findByEmojiId(e)),void 0)}findById(e){return this.isLoaded()&&this.isRepositoryAvailable(this.emojiRepository)?this.emojiRepository.findById(e):this.retryIfLoading((()=>this.findById(e)),void 0)}findInCategory(e){return this.isLoaded()&&this.isRepositoryAvailable(this.emojiRepository)?Promise.resolve(this.emojiRepository.findInCategory(e)):this.retryIfLoading((()=>this.findInCategory(e)),[])}getAsciiMap(){return this.isLoaded()&&this.isRepositoryAvailable(this.emojiRepository)?Promise.resolve(this.emojiRepository.getAsciiMap()):this.retryIfLoading((()=>this.getAsciiMap()),new Map)}getFrequentlyUsed(e){return this.isLoaded()&&this.isRepositoryAvailable(this.emojiRepository)?Promise.resolve(this.emojiRepository.getFrequentlyUsed(e)):this.retryIfLoading((()=>this.getFrequentlyUsed(e)),[])}recordSelection(e){const{recordConfig:i}=this;if(this.isRepositoryAvailable(this.emojiRepository)&&this.emojiRepository.used(e),i){const t={emojiId:(0,h.Vo)(e)},o={method:"POST"};return r.P6.requestService(i,{queryParams:t,requestInit:o})}return Promise.resolve()}deleteSiteEmoji(e){return this.isRepositoryAvailable(this.siteEmojiResource)&&e.id?this.siteEmojiResource.deleteEmoji(e).then((i=>!(!i||!this.isRepositoryAvailable(this.emojiRepository))&&(this.emojiRepository.delete(e),!0))).catch((e=>(console.error("failed to delete site emoji",e),!1))):this.retryIfLoading((()=>this.deleteSiteEmoji(e)),!1)}getSelectedTone(){return this.selectedTone}setSelectedTone(e){if(this.selectedTone=e,"undefined"!=typeof window&&(0,d.Z)("localStorage"))try{window.localStorage.setItem(n.Qz,e?e.toString():"")}catch(i){console.error("failed to store selected emoji skin tone",i)}}calculateDynamicCategories(){return this.isLoaded()&&this.isRepositoryAvailable(this.emojiRepository)?Promise.resolve(this.emojiRepository.getDynamicCategoryList()):this.retryIfLoading((()=>this.calculateDynamicCategories()),[])}getCurrentUser(){return this.currentUser}addUnknownEmoji(e){this.isRepositoryAvailable(this.emojiRepository)&&this.emojiRepository.addUnknownEmoji(e)}}class Z extends k{constructor(e){super(e),(0,s.Z)(this,"allowUpload",void 0),this.allowUpload=!!e.allowUpload}isUploadSupported(){return this.allowUpload?this.isRepositoryAvailable(this.siteEmojiResource)?this.siteEmojiResource.hasUploadToken():this.retryIfLoading((()=>this.isUploadSupported()),!1):Promise.resolve(!1)}uploadCustomEmoji(e,i=!1){return this.isUploadSupported().then((t=>t&&this.isRepositoryAvailable(this.siteEmojiResource)?this.siteEmojiResource.uploadEmoji(e,i).then((i=>(i.representation.imagePath=e.dataURL,this.addUnknownEmoji(i),this.refreshLastFilter(),i))):Promise.reject("No media api support is configured")))}prepareForUpload(){return this.isRepositoryAvailable(this.siteEmojiResource)&&this.siteEmojiResource.prepareForUpload(),this.retryIfLoading((()=>this.prepareForUpload()),void 0)}}},314942:(e,i,t)=>{t.d(i,{KO:()=>o,Sy:()=>r,To:()=>a,e6:()=>s});const o=e=>new Promise(((i,t)=>{const o=new Image;o.addEventListener("load",(()=>{i({width:o.naturalWidth,height:o.naturalHeight})})),o.addEventListener("error",t),o.src=e})),s=e=>new Promise(((i,t)=>{let o=new Image;o.onload=()=>i({src:o.src}),o.onerror=()=>t(),o.src=e})),r=e=>e&&e.size>1048576;let n;const a=()=>(void 0!==n?Promise.resolve(n):new Promise((e=>{const i=new Image,t=()=>{n=2===i.height,e(n)};i.addEventListener("load",t),i.addEventListener("error",t),i.src="data:image/webp;base64,UklGRi4AAABXRUJQVlA4TCEAAAAvAUAAEB8wAiMwAgSSNtse/cXjxyCCmrYNWPwmHRH9jwMA"}))).then((e=>e?"image/webp,image/*,*/*;q=0.8":"image/*,*/*;q=0.8"))}}]);
//# sourceMappingURL=72178.AZ7GCuY1C2.js.map